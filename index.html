<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Party Jukebox - Collaborative Music Queue</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js" onload="console.log('QRCode library loaded')" onerror="console.log('QRCode library failed to load')"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #00f260 0%, #0575e6 50%, #667eea 100%);
            min-height: 100vh;
            color: white;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .role-selector {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
        }

        .role-btn {
            padding: 15px 30px;
            font-size: 1.2rem;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .role-btn.host {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
        }

        .role-btn.guest {
            background: linear-gradient(45deg, #00b894, #00cec9);
        }

        .role-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .section {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .room-setup {
            text-align: center;
        }

        .room-code {
            font-size: 2rem;
            font-weight: bold;
            background: rgba(255,255,255,0.2);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            letter-spacing: 3px;
        }

        .qr-container {
            margin: 20px 0;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #qrcode {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #qrcode canvas,
        #qrcode table,
        #qrcode img {
            margin: 0 auto;
            display: block;
        }

        .player-section {
            text-align: center;
        }

        .current-song {
            margin-bottom: 20px;
        }

        .song-title {
            font-size: 1.5rem;
            margin-bottom: 10px;
        }

        .player-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
        }

        .control-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            background: rgba(255,255,255,0.2);
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
        }

        .control-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-1px);
        }

        .add-song-section {
            margin-bottom: 25px;
        }

        .song-input {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 25px;
            font-size: 1rem;
            margin-bottom: 15px;
            background: rgba(255,255,255,0.9);
            color: #333;
        }

        .add-btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 25px;
            background: linear-gradient(45deg, #74b9ff, #0984e3);
            color: white;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .add-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
        }

        .queue-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .queue-item {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .song-info {
            flex: 1;
        }

        .song-name {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .added-by {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .vote-section {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .vote-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .vote-up {
            background: #55a3ff;
            color: white;
        }

        .vote-down {
            background: #fd79a8;
            color: white;
        }

        .vote-count {
            font-weight: bold;
            min-width: 30px;
            text-align: center;
        }

        .join-section {
            text-align: center;
        }

        .join-input {
            padding: 15px;
            border: none;
            border-radius: 25px;
            font-size: 1.2rem;
            margin-right: 10px;
            background: rgba(255,255,255,0.9);
            color: #333;
            width: 200px;
            text-align: center;
            letter-spacing: 2px;
        }

        .join-btn {
            padding: 15px 30px;
            border: none;
            border-radius: 25px;
            background: linear-gradient(45deg, #74b9ff, #0984e3);
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .hidden {
            display: none;
        }

        .status {
            text-align: center;
            padding: 10px;
            margin: 10px 0;
            border-radius: 10px;
            background: rgba(255,255,255,0.1);
        }

        #player {
            width: 100%;
            height: 315px;
            border-radius: 15px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>üéµ Party Jukebox</h1>
        <p>Collaborative Music Queue for Your Party</p>
    </div>

    <!-- Role Selection -->
    <div id="roleSelection" class="section">
        <div class="role-selector">
            <button class="role-btn host" onclick="setRole('host')">
                üé§ Host Party
            </button>
            <button class="role-btn guest" onclick="setRole('guest')">
                üéµ Join Party
            </button>
        </div>
        <div style="text-align: center; margin-top: 15px; opacity: 0.8;">
            <span id="currentUserName"></span>
        </div>
    </div>

    <!-- Host Setup -->
    <div id="hostSetup" class="section hidden">
        <div class="room-setup">
            <h2>üéâ Your Party Room</h2>
            <p>Share this code with your guests:</p>
            <div class="room-code" id="roomCode">PARTY123</div>
            <div class="qr-container">
                <div id="qrcode"></div>
            </div>
            <p>Or share this link:</p>
            <div id="shareLink" class="room-code" style="font-size: 1rem; word-break: break-all;"></div>
        </div>
    </div>

    <!-- Guest Join -->
    <div id="guestJoin" class="section hidden">
        <div class="join-section">
            <h2>üéµ Join the Party</h2>
            <p>Enter the party code:</p>
            <input type="text" id="joinCode" class="join-input" placeholder="PARTY123" maxlength="8">
            <button class="join-btn" onclick="joinRoom()">Join</button>
        </div>
    </div>

    <!-- Music Player (Host Only) -->
    <div id="playerSection" class="section hidden">
        <div class="player-section">
            <h2>üéµ Now Playing</h2>
            <div class="current-song">
                <div class="song-title" id="currentSongTitle">No song playing</div>
                <div id="player"></div>
            </div>
            <div class="player-controls">
                <button class="control-btn" onclick="previousSong()">‚èÆÔ∏è Previous</button>
                <button class="control-btn" onclick="togglePlayPause()" id="playPauseBtn">‚ñ∂Ô∏è Play</button>
                <button class="control-btn" onclick="nextSong()">‚è≠Ô∏è Next</button>
            </div>
        </div>
    </div>

    <!-- Add Song Section -->
    <div id="addSongSection" class="section hidden">
        <div class="add-song-section">
            <h2>‚ûï Add a Song</h2>
            <div style="text-align: center; margin-bottom: 10px; opacity: 0.8; font-size: 0.9rem;">
                Adding as: <strong id="addingSongAs"></strong>
            </div>
            <input type="text" id="songSearch" class="song-input" placeholder="Search for a song or paste YouTube URL...">
            <button class="add-btn" onclick="addSong()">Add to Queue</button>
        </div>
    </div>

    <!-- Queue Section -->
    <div id="queueSection" class="section hidden">
        <h2>üéµ Music Queue</h2>
        <div class="queue-list" id="queueList">
            <!-- Queue items will be added here -->
        </div>
    </div>

    <!-- Status Messages -->
    <div id="status" class="status hidden"></div>
</div>

<script>
    // Global variables
    let currentRole = null;
    let roomCode = null;
    let queue = [];
    let currentSongIndex = -1;
    let player = null;
    let isPlaying = false;
    let userName = '';

    // Initialize user on page load
    function initializeUser() {
        // Try to get stored name first
        const storedName = getUserName();

        if (storedName) {
            userName = storedName;
            showStatus(`üëã Welcome back, ${userName}!`);
        } else {
            // Prompt for name and store it
            promptForName();
        }
    }

    // Prompt user for their name
    function promptForName() {
        let name = '';
        while (!name || name.trim().length === 0) {
            name = prompt('üéµ Welcome to Party Jukebox! What\'s your name?');
            if (name === null) {
                // User cancelled, use default
                name = 'Anonymous';
                break;
            }
            name = name.trim();
            if (name.length === 0) {
                alert('Please enter a valid name!');
            }
        }

        userName = name;
        storeUserName(userName);
        showStatus(`üéâ Hey ${userName}! Ready to add some music?`);
    }

    // Store user name in memory (since localStorage is not available)
    let storedUserData = { name: '' };

    function storeUserName(name) {
        storedUserData.name = name;
    }

    function getUserName() {
        return storedUserData.name;
    }

    // Generate a random room code
    function generateRoomCode() {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
        let result = '';
        for (let i = 0; i < 6; i++) {
            result += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return result;
    }

    // Set user role (host or guest)
    function setRole(role) {
        currentRole = role;
        document.getElementById('roleSelection').classList.add('hidden');

        if (role === 'host') {
            setupHost();
        } else {
            setupGuest();
        }
    }

    // Setup host interface
    function setupHost() {
        roomCode = generateRoomCode();
        document.getElementById('roomCode').textContent = roomCode;
        document.getElementById('hostSetup').classList.remove('hidden');
        document.getElementById('playerSection').classList.remove('hidden');
        document.getElementById('addSongSection').classList.remove('hidden');
        document.getElementById('queueSection').classList.remove('hidden');

        // Generate QR code
        const shareUrl = window.location.origin + window.location.pathname + '?room=' + roomCode;
        document.getElementById('shareLink').textContent = shareUrl;

        // Generate QR code with fallback
        generateQRCode(shareUrl);

        // Initialize YouTube player
        loadYouTubeAPI();

        showStatus('üéâ Party room created! Share the code with your friends.');
    }

    // Generate QR code with fallback
    function generateQRCode(url) {
        const qrContainer = document.getElementById('qrcode');

        if (typeof QRCode !== 'undefined') {
            // Clear any existing content
            qrContainer.innerHTML = '';

            // Create QR code using qrcodejs library
            new QRCode(qrContainer, {
                text: url,
                width: 200,
                height: 200,
                colorDark: '#000000',
                colorLight: '#ffffff',
                correctLevel: QRCode.CorrectLevel.M
            });
        } else {
            // Fallback: create a simple placeholder
            qrContainer.innerHTML = `
                    <div style="width: 200px; height: 200px; background: white; border: 2px solid #ccc; display: flex; flex-direction: column; justify-content: center; align-items: center; font-family: Arial; color: #333;">
                        <div style="font-size: 16px; font-weight: bold; margin-bottom: 10px;">QR Code</div>
                        <div style="font-size: 12px; text-align: center; padding: 0 10px;">Scan with phone camera</div>
                        <div style="font-size: 10px; margin-top: 10px; opacity: 0.7;">Loading...</div>
                    </div>
                `;

            // Try to load QR library again
            setTimeout(() => {
                if (typeof QRCode !== 'undefined') {
                    qrContainer.innerHTML = '';
                    new QRCode(qrContainer, {
                        text: url,
                        width: 200,
                        height: 200,
                        colorDark: '#000000',
                        colorLight: '#ffffff',
                        correctLevel: QRCode.CorrectLevel.M
                    });
                }
            }, 1000);
        }
    }

    // Setup guest interface
    function setupGuest() {
        document.getElementById('guestJoin').classList.remove('hidden');

        // Check if room code is in URL
        const urlParams = new URLSearchParams(window.location.search);
        const urlRoomCode = urlParams.get('room');
        if (urlRoomCode) {
            document.getElementById('joinCode').value = urlRoomCode;
            // Auto-join if valid room code in URL
            setTimeout(() => {
                joinRoom();
            }, 500);
        }
    }

    // Join a room as guest
    function joinRoom() {
        const code = document.getElementById('joinCode').value.toUpperCase();
        if (code.length !== 6) {
            showStatus('‚ùå Please enter a valid 6-character room code.');
            return;
        }

        roomCode = code;
        document.getElementById('guestJoin').classList.add('hidden');
        document.getElementById('addSongSection').classList.remove('hidden');
        document.getElementById('queueSection').classList.remove('hidden');

        showStatus(`üéµ Welcome ${userName}! You've joined room ${roomCode}.`);
        updateQueue();
    }

    // Load YouTube API
    function loadYouTubeAPI() {
        if (typeof YT === 'undefined') {
            const tag = document.createElement('script');
            tag.src = 'https://www.youtube.com/iframe_api';
            const firstScriptTag = document.getElementsByTagName('script')[0];
            firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
        }
    }

    // YouTube API ready callback
    function onYouTubeIframeAPIReady() {
        player = new YT.Player('player', {
            height: '315',
            width: '100%',
            playerVars: {
                'playsinline': 1,
                'controls': 1,
                'rel': 0
            },
            events: {
                'onReady': onPlayerReady,
                'onStateChange': onPlayerStateChange
            }
        });
    }

    function onPlayerReady(event) {
        console.log('Player ready');
    }

    function onPlayerStateChange(event) {
        if (event.data === YT.PlayerState.ENDED) {
            nextSong();
        } else if (event.data === YT.PlayerState.PLAYING) {
            isPlaying = true;
            document.getElementById('playPauseBtn').textContent = '‚è∏Ô∏è Pause';
        } else if (event.data === YT.PlayerState.PAUSED) {
            isPlaying = false;
            document.getElementById('playPauseBtn').textContent = '‚ñ∂Ô∏è Play';
        }
    }

    // Extract YouTube video ID from URL
    function extractYouTubeID(url) {
        const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
        const match = url.match(regExp);
        return (match && match[2].length === 11) ? match[2] : null;
    }

    // Fetch YouTube video title
    async function getYouTubeTitle(videoId) {
        try {
            // Use YouTube's oEmbed API to get video info
            const response = await fetch(`https://www.youtube.com/oembed?url=https://www.youtube.com/watch?v=${videoId}&format=json`);

            if (response.ok) {
                const data = await response.json();
                return data.title;
            } else {
                throw new Error('Failed to fetch video info');
            }
        } catch (error) {
            console.error('Error fetching YouTube title:', error);
            return `YouTube Video (${videoId})`;
        }
    }

    // Add song to queue
    async function addSong() {
        const input = document.getElementById('songSearch');
        const query = input.value.trim();

        if (!query) {
            showStatus('‚ùå Please enter a song name or YouTube URL.');
            return;
        }

        // Check if it's a YouTube URL
        const videoId = extractYouTubeID(query);

        if (videoId) {
            // It's a YouTube URL - fetch the actual title
            showStatus('üîç Getting video info...');
            const title = await getYouTubeTitle(videoId);
            addToQueue(videoId, title, userName);
        } else {
            // It's a search query - simulate finding a song
            showStatus('üîç Searching for "' + query + '"...');

            // For demo purposes, try to find a similar song on YouTube
            // In a real app, you'd use YouTube Data API to search
            const searchResults = await searchYouTube(query);

            if (searchResults.videoId) {
                addToQueue(searchResults.videoId, searchResults.title, userName);
            } else {
                // Fallback to demo video with search term as title
                const demoVideoId = 'dQw4w9WgXcQ'; // Rick Roll as demo
                addToQueue(demoVideoId, `"${query}" (Demo - Rick Roll)`, userName);
                showStatus('‚ö†Ô∏è Demo mode: Using placeholder video. In a real app, this would search YouTube.');
            }
        }

        input.value = '';
    }

    // Simulate YouTube search (in real app, use YouTube Data API)
    async function searchYouTube(query) {
        // This is a demo function. In a real app, you'd use YouTube Data API
        // For now, we'll return some common songs based on keywords

        const commonSongs = {
            'hello': { videoId: '1RHBAd5Tj_o', title: 'Adele - Hello' },
            'shape of you': { videoId: 'JGwWNGJdvx8', title: 'Ed Sheeran - Shape of You' },
            'bohemian rhapsody': { videoId: 'fJ9rUzIMcZQ', title: 'Queen - Bohemian Rhapsody' },
            'imagine': { videoId: 'YkgkThdzX-8', title: 'John Lennon - Imagine' },
            'billie jean': { videoId: 'Zi_XLOBDo_Y', title: 'Michael Jackson - Billie Jean' },
            'hotel california': { videoId: 'BciS5krYL80', title: 'Eagles - Hotel California' },
            'sweet child': { videoId: '1w7OgIMMRc4', title: 'Guns N\' Roses - Sweet Child O\' Mine' },
            'stairway to heaven': { videoId: 'QkF3oxziUI4', title: 'Led Zeppelin - Stairway to Heaven' },
            'yesterday': { videoId: 'NrgmdVjpVws', title: 'The Beatles - Yesterday' },
            'like a rolling stone': { videoId: 'IwOfCgkyEj0', title: 'Bob Dylan - Like a Rolling Stone' }
        };

        const lowerQuery = query.toLowerCase();

        // Check if query matches any common songs
        for (const [key, song] of Object.entries(commonSongs)) {
            if (lowerQuery.includes(key) || key.includes(lowerQuery)) {
                return song;
            }
        }

        // No match found
        return { videoId: null, title: null };
    }

    // Add song to queue
    function addToQueue(videoId, title, addedBy) {
        const song = {
            id: Date.now(),
            videoId: videoId,
            title: title,
            addedBy: addedBy,
            votes: 0
        };

        queue.push(song);
        updateQueue();
        showStatus(`‚úÖ "${title}" added to queue by ${addedBy}`);

        // If nothing is playing and this is the first song, start playing
        if (currentRole === 'host' && currentSongIndex === -1 && queue.length === 1) {
            playNextSong();
        }
    }

    // Update queue display
    function updateQueue() {
        const queueList = document.getElementById('queueList');
        queueList.innerHTML = '';

        if (queue.length === 0) {
            queueList.innerHTML = '<p style="text-align: center; opacity: 0.7;">No songs in queue. Add some music!</p>';
            return;
        }

        queue.forEach((song, index) => {
            const item = document.createElement('div');
            item.className = 'queue-item';

            const isCurrentSong = index === currentSongIndex;
            if (isCurrentSong) {
                item.style.background = 'rgba(255,255,255,0.2)';
                item.style.border = '2px solid rgba(255,255,255,0.3)';
            }

            item.innerHTML = `
                    <div class="song-info">
                        <div class="song-name">${isCurrentSong ? 'üéµ ' : ''}${song.title}</div>
                        <div class="added-by">Added by ${song.addedBy}</div>
                    </div>
                    <div class="vote-section">
                        <button class="vote-btn vote-up" onclick="vote(${song.id}, 1)">üëç</button>
                        <div class="vote-count">${song.votes}</div>
                        <button class="vote-btn vote-down" onclick="vote(${song.id}, -1)">üëé</button>
                        ${currentRole === 'host' ? `<button class="vote-btn" onclick="removeSong(${song.id})" style="background: #ff6b6b; margin-left: 10px;">‚ùå</button>` : ''}
                    </div>
                `;

            queueList.appendChild(item);
        });
    }

    // Vote for a song
    function vote(songId, direction) {
        const songIndex = queue.findIndex(song => song.id === songId);
        if (songIndex !== -1) {
            queue[songIndex].votes += direction;

            // Sort queue by votes (except currently playing song)
            if (currentSongIndex !== -1) {
                const currentSong = queue[currentSongIndex];
                const otherSongs = queue.filter((_, index) => index !== currentSongIndex);
                otherSongs.sort((a, b) => b.votes - a.votes);

                queue = [currentSong, ...otherSongs];
            } else {
                queue.sort((a, b) => b.votes - a.votes);
            }

            updateQueue();
        }
    }

    // Remove song from queue (host only)
    function removeSong(songId) {
        const songIndex = queue.findIndex(song => song.id === songId);
        if (songIndex !== -1) {
            if (songIndex === currentSongIndex) {
                nextSong();
            } else {
                queue.splice(songIndex, 1);
                if (songIndex < currentSongIndex) {
                    currentSongIndex--;
                }
                updateQueue();
            }
        }
    }

    // Play next song
    function playNextSong() {
        if (queue.length === 0) {
            currentSongIndex = -1;
            document.getElementById('currentSongTitle').textContent = 'No songs in queue';
            return;
        }

        currentSongIndex = (currentSongIndex + 1) % queue.length;
        const song = queue[currentSongIndex];

        if (player && player.loadVideoById) {
            player.loadVideoById(song.videoId);
            document.getElementById('currentSongTitle').textContent = song.title;
            updateQueue();
        }
    }

    // Player controls
    function togglePlayPause() {
        if (player && player.getPlayerState) {
            if (isPlaying) {
                player.pauseVideo();
            } else {
                player.playVideo();
            }
        }
    }

    function nextSong() {
        playNextSong();
    }

    function previousSong() {
        if (currentSongIndex > 0) {
            currentSongIndex -= 2; // Will be incremented in playNextSong
            playNextSong();
        }
    }

    // Show status message
    function showStatus(message) {
        const status = document.getElementById('status');
        status.textContent = message;
        status.classList.remove('hidden');

        setTimeout(() => {
            status.classList.add('hidden');
        }, 5000);
    }

    // Handle enter key in input fields
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize user when page loads
        initializeUser();

        // Update display with current user name
        function updateUserDisplay() {
            const userNameDisplay = document.getElementById('currentUserName');
            if (userNameDisplay) {
                userNameDisplay.textContent = `üë§ ${userName}`;
            }
        }

        // Update user display initially and whenever name changes
        updateUserDisplay();

        // Update "adding as" display
        function updateAddingAsDisplay() {
            const addingAsElement = document.getElementById('addingSongAs');
            if (addingAsElement) {
                addingAsElement.textContent = userName;
            }
        }

        document.getElementById('songSearch').addEventListener('keypress', async function(e) {
            if (e.key === 'Enter') {
                await addSong();
            }
        });

        document.getElementById('joinCode').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                joinRoom();
            }
        });

        // Update user display periodically in case name changes
        setInterval(() => {
            updateUserDisplay();
            updateAddingAsDisplay();
        }, 1000);
    });

    // Make YouTube API callback global
    window.onYouTubeIframeAPIReady = onYouTubeIframeAPIReady;
</script>
</body>
</html>